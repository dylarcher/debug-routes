<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CapitalRx Route Debugger</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }

      .container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #0071b3;
        border-bottom: 2px solid #0071b3;
        padding-bottom: 10px;
      }

      .diagnostic-section {
        margin: 20px 0;
        padding: 20px;
        border-left: 4px solid #ddd;
        background: #fafafa;
      }

      .issue {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }

      .issue.high {
        background: #ffebee;
        border-left: 4px solid #f44336;
      }

      .issue.medium {
        background: #fff8e1;
        border-left: 4px solid #ff9800;
      }

      .issue.low {
        background: #e8f5e8;
        border-left: 4px solid #4caf50;
      }

      .recommendation {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 10px;
        margin: 10px 0;
      }

      button {
        background: #0071b3;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }

      button:hover {
        background: #005a8b;
      }

      #results {
        margin-top: 20px;
      }

      .code {
        background: #f4f4f4;
        padding: 10px;
        border-radius: 4px;
        font-family: "Courier New", monospace;
        margin: 10px 0;
      }

      .monitor {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #333;
        color: white;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        z-index: 10000;
        max-width: 300px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîß CapitalRx Route Debugger</h1>
      <p>This tool helps diagnose React Router unmounting issues in CapitalRx shell modules.</p>

      <div class="diagnostic-section">
        <h2>üîç Quick Diagnostics</h2>
        <button onclick="runQuickDiagnostics()">Run Diagnostics</button>
        <button onclick="startRouteMonitor()">Start Route Monitor</button>
        <button onclick="stopRouteMonitor()">Stop Route Monitor</button>
        <button onclick="analyzeCurrentPage()">Analyze Current Page</button>
      </div>

      <div class="diagnostic-section">
        <h2>üõ† Debug Tools</h2>
        <button onclick="injectDebugCode()">Inject Debug Utilities</button>
        <button onclick="showReactDevTools()">Open React DevTools</button>
        <button onclick="exportDiagnostics()">Export Diagnostics</button>
      </div>

      <div id="results"></div>
    </div>

    <div id="monitor" class="monitor" style="display: none">
      <div id="monitor-content"></div>
    </div>

    <script>
      // Debug utilities that can be injected into any CapitalRx page
      const debugUtilities = {
        routeChanges: [],
        componentMounts: new Map(),
        startTime: Date.now(),

        // Monitor route changes
        monitorRoutes() {
          const originalPushState = history.pushState;
          const originalReplaceState = history.replaceState;

          history.pushState = function (...args) {
            debugUtilities.logRouteChange("pushState", args[2] || location.pathname);
            return originalPushState.apply(this, args);
          };

          history.replaceState = function (...args) {
            debugUtilities.logRouteChange("replaceState", args[2] || location.pathname);
            return originalReplaceState.apply(this, args);
          };

          window.addEventListener("popstate", (e) => {
            debugUtilities.logRouteChange("popstate", location.pathname);
          });

          // Monitor React Router if available
          if (window.React) {
            debugUtilities.injectReactMonitoring();
          }
        },

        logRouteChange(type, path) {
          const change = {
            type,
            path,
            timestamp: Date.now(),
            elapsed: Date.now() - this.startTime,
          };

          this.routeChanges.push(change);
          this.updateMonitor(`${type}: ${path} (${change.elapsed}ms)`);

          // Check for potential issues
          this.checkForIssues(change);
        },

        checkForIssues(change) {
          // Check for rapid route changes (possible unmount/remount cycle)
          const recent = this.routeChanges.filter((c) => Date.now() - c.timestamp < 1000).length;

          if (recent > 3) {
            console.warn("‚ö†Ô∏è Rapid route changes detected - possible unmount/remount cycle");
          }

          // Check for same-route navigation
          if (this.routeChanges.length > 1) {
            const previous = this.routeChanges[this.routeChanges.length - 2];
            if (previous.path === change.path) {
              console.warn("‚ö†Ô∏è Navigation to same route detected - possible route instability");
            }
          }
        },

        updateMonitor(message) {
          const monitor = document.getElementById("monitor-content");
          if (monitor) {
            const line = document.createElement("div");
            line.textContent = new Date().toLocaleTimeString() + ": " + message;
            monitor.appendChild(line);

            // Keep only last 10 lines
            while (monitor.children.length > 10) {
              monitor.removeChild(monitor.firstChild);
            }
          }
        },

        injectReactMonitoring() {
          // Try to detect React Router components
          if (window.ReactDOM && window.ReactDOM._internalInstanceKey) {
            console.log("üîç React Router monitoring enabled");
          }
        },

        analyzeCurrentRoute() {
          const analysis = {
            pathname: location.pathname,
            search: location.search,
            hash: location.hash,
            routeChanges: this.routeChanges.length,
            potentialIssues: [],
          };

          // Check for shell patterns
          if (location.pathname.includes("/module/")) {
            analysis.moduleDetected = true;
            analysis.moduleId = location.pathname.split("/module/")[1]?.split("/")[0];
          }

          // Check for query parameters that might indicate issues
          const params = new URLSearchParams(location.search);
          if (params.has("redirect")) {
            analysis.potentialIssues.push("Redirect parameter detected - possible routing issue");
          }

          return analysis;
        },

        exportDiagnostics() {
          return {
            timestamp: new Date().toISOString(),
            location: location.href,
            routeChanges: this.routeChanges,
            analysis: this.analyzeCurrentRoute(),
            userAgent: navigator.userAgent,
            reactVersion: window.React?.version,
            shellDetected: !!window.CapitalRxShell,
          };
        },
      };

      function runQuickDiagnostics() {
        const results = document.getElementById("results");
        results.innerHTML = "<h3>üîç Running Diagnostics...</h3>";

        const issues = [];
        const recommendations = [];

        // Check for React
        if (!window.React) {
          issues.push({
            severity: "high",
            message: "React not detected in global scope",
            type: "environment",
          });
        } else {
          issues.push({
            severity: "low",
            message: `React ${window.React.version} detected`,
            type: "info",
          });
        }

        // Check for React Router
        if (!window.ReactRouter && !document.querySelector('[data-testid*="route"]')) {
          issues.push({
            severity: "medium",
            message: "React Router not clearly detected",
            type: "routing",
          });
          recommendations.push("Ensure React Router is properly loaded");
        }

        // Check for CapitalRx Shell
        if (window.CapitalRxShell || location.pathname.includes("/module/")) {
          issues.push({
            severity: "low",
            message: "CapitalRx Shell environment detected",
            type: "info",
          });
        } else {
          issues.push({
            severity: "medium",
            message: "CapitalRx Shell not detected - may not be in shell environment",
            type: "environment",
          });
        }

        // Check for multiple React instances (common issue)
        const reactScripts = Array.from(document.scripts).filter((s) => s.src && s.src.includes("react"));
        if (reactScripts.length > 2) {
          issues.push({
            severity: "high",
            message: `Multiple React scripts detected (${reactScripts.length}) - may cause issues`,
            type: "performance",
          });
          recommendations.push("Check for duplicate React imports");
        }

        displayResults(issues, recommendations);
      }

      function displayResults(issues, recommendations) {
        const results = document.getElementById("results");
        let html = "<h3>üìä Diagnostic Results</h3>";

        // Group issues by severity
        const highIssues = issues.filter((i) => i.severity === "high");
        const mediumIssues = issues.filter((i) => i.severity === "medium");
        const lowIssues = issues.filter((i) => i.severity === "low");

        if (highIssues.length > 0) {
          html += "<h4>üö® High Severity Issues</h4>";
          highIssues.forEach((issue) => {
            html += `<div class="issue high">‚ùå ${issue.message}</div>`;
          });
        }

        if (mediumIssues.length > 0) {
          html += "<h4>‚ö†Ô∏è Medium Severity Issues</h4>";
          mediumIssues.forEach((issue) => {
            html += `<div class="issue medium">‚ö†Ô∏è ${issue.message}</div>`;
          });
        }

        if (lowIssues.length > 0) {
          html += "<h4>‚ÑπÔ∏è Information</h4>";
          lowIssues.forEach((issue) => {
            html += `<div class="issue low">‚ÑπÔ∏è ${issue.message}</div>`;
          });
        }

        if (recommendations.length > 0) {
          html += "<h4>üí° Recommendations</h4>";
          recommendations.forEach((rec) => {
            html += `<div class="recommendation">üí° ${rec}</div>`;
          });
        }

        results.innerHTML = html;
      }

      function startRouteMonitor() {
        document.getElementById("monitor").style.display = "block";
        debugUtilities.monitorRoutes();
        debugUtilities.updateMonitor("Route monitoring started");
      }

      function stopRouteMonitor() {
        document.getElementById("monitor").style.display = "none";
      }

      function analyzeCurrentPage() {
        const analysis = debugUtilities.analyzeCurrentRoute();
        const results = document.getElementById("results");

        let html = "<h3>üìÑ Current Page Analysis</h3>";
        html += `<div class="code">
                <strong>Current URL:</strong> ${analysis.pathname}<br>
                <strong>Route Changes:</strong> ${analysis.routeChanges}<br>
                <strong>Module Detected:</strong> ${analysis.moduleDetected ? analysis.moduleId : "No"}<br>
            </div>`;

        if (analysis.potentialIssues.length > 0) {
          html += "<h4>‚ö†Ô∏è Potential Issues</h4>";
          analysis.potentialIssues.forEach((issue) => {
            html += `<div class="issue medium">${issue}</div>`;
          });
        }

        results.innerHTML = html;
      }

      function injectDebugCode() {
        // Inject the debug utilities into the current page
        const script = document.createElement("script");
        script.textContent = `
                // Route unmount debugger
                window.useRouteUnmountDebugger = function(componentName) {
                    console.log('üîç Debugging component:', componentName);
                    return { renderCount: 1, lifespan: 0 };
                };
                
                // Route analyzer
                window.CapitalRxRouteDebugger = {
                    analyzeRouteConfiguration: function(routes, modules) {
                        console.log('üîç Analyzing routes:', routes);
                        return [];
                    },
                    diagnoseUnmountIssues: function(config) {
                        console.log('üîç Diagnosing unmount issues:', config);
                        return { issues: [], recommendations: [], severity: 'low' };
                    }
                };
                
                console.log('‚úÖ CapitalRx debug utilities injected');
            `;
        document.head.appendChild(script);

        const results = document.getElementById("results");
        results.innerHTML = "<h3>‚úÖ Debug Code Injected</h3><p>Check browser console for debug utilities.</p>";
      }

      function showReactDevTools() {
        if (window.__REACT_DEVTOOLS_GLOBAL_HOOK__) {
          alert('React DevTools detected! Open your browser\'s developer tools and look for the "‚öõÔ∏è Components" and "‚öõÔ∏è Profiler" tabs.');
        } else {
          alert("React DevTools not detected. Please install the React Developer Tools browser extension.");
        }
      }

      function exportDiagnostics() {
        const diagnostics = debugUtilities.exportDiagnostics();
        const blob = new Blob([JSON.stringify(diagnostics, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `capitalrx-route-diagnostics-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }

      // Initialize
      console.log("üîß CapitalRx Route Debugger loaded");
      console.log("Use the buttons above to run diagnostics or monitor route changes.");
    </script>
  </body>
</html>
